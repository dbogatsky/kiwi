<!--Shared javascript -->
<!-- <script src="/assets/bootstrap/js/jquery-1.11.1.min.js"></script> -->
<script src="/assets/bootstrap/js/jquery-migrate-1.2.1.min.js"></script>
<script src="/assets/bootstrap/js/jquery-ui-1.10.3.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap.min.js"></script>
<script src="/assets/bootstrap/js/modernizr.min.js"></script>
<script src="/assets/bootstrap/js/jquery.sparkline.min.js"></script>
<script src="/assets/bootstrap/js/toggles.min.js"></script>
<!-- <script src="/assets/bootstrap/js/retina.min.js"></script> -->

<script src="/assets/bootstrap/js/morris.min.js"></script>
<script src="/assets/bootstrap/js/raphael-2.1.0.min.js"></script>
<script src="/assets/bootstrap/js/jquery.datatables.min.js"></script>


<!--<script src="http://maps.google.com/maps/api/js?sensor=true"></script>-->
<!-- <script src="http://maps.google.com/maps/api/js"></script> -->
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCgqcu1Jqqdc0a4hVnfRvw0hyJM832rqXA&libraries=places"></script>
<script src="/assets/bootstrap/js/gmaps.js"></script>
<script src="/assets/bootstrap/js/jquery.twbsPagination.min.js"></script>


<!--TEST all included javascripts -->
<script src="/assets/bootstrap/js/holder.js"></script>

<!-- Form elements - status and date picker -->
<script src="/assets/vertical-timeline/js/main.js"></script>
<script src="/assets/bootstrap/js/bootstrap-timepicker.min.js"></script>
<script src="/assets/bootstrap/js/jquery.maskedinput.min.js"></script>
<script src="/assets/bootstrap/js/jquery.tagsinput.min.js"></script>
<script src="/assets/bootstrap/js/jquery.mousewheel.js"></script>
<script src="/assets/bootstrap/js/select2.min.js"></script>
<script src="/assets/bootstrap/js/jquery.validate.min.js"></script>
<!-- <script src="assets/bootstrap/js/additional-methods.min.js"></script> -->
<script src="/assets/bootstrap/js/bootstrap-editable.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap-datetimepicker.min.js"></script>
<script src="/assets/bootstrap/js/moment.min.js"></script>
<script src="/assets/bootstrap/js/jquery.cookies.js"></script>
<script src="/assets/bootstrap/js/jquery.autogrow-textarea.js"></script>
<script src="/assets/bootstrap/js/cropper.min.js"></script>
<script src="/assets/bootstrap/js/jquery.gritter.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap-wizard.min.js"></script>
<script src="/assets/scripts/wyshtml5/wyshtml5.js"></script>
<script src="/assets/scripts/wyshtml5/bootstrap-wysihtml5.js"></script>
<script src="/assets/bootstrap/js/fullcalendar.min.js"></script>
<script src="/assets/bootstrap/js/jquery.ui.touch-punch.min.js"></script>
<script src="/assets/bootstrap/js/jquery.confirm.js"></script>
<!-- end test -->

<script src="/assets/bootstrap/js/custom.js"></script>
<!-- <script src="/assets/scripts/gmap.js"></script> -->



<script>
  mobile = '<%=mobile?%>'
  $(document).ready(function() {
    function address_auto_fill(e){
      var componentForm = {
        street_number: 'short_name',
        route: 'long_name',
        locality: 'long_name',
        administrative_area_level_1: 'long_name',
        country: 'short_name',
        postal_code: 'short_name'
      };
      var autocomplete = new google.maps.places.Autocomplete(e);
      autocomplete.addListener('place_changed', fillInAddress);

      function fillInAddress() {
        var place = autocomplete.getPlace();
        if (e.id == 'account_name'){

          $("#account_name").val(titleize(place.name))
        }
        var lat = place.geometry.location.lat();
        var lng = place.geometry.location.lng();

        $("#account_lat").val(lat);
        $("#account_lng").val(lng);

        for (var component in componentForm) {
          if (component != 'route'){
            $('#'+component).val('');
            $('#'+component).attr('readonly', false)
          }
        }

        for (var i = 0; i < place.address_components.length; i++) {
          var addressType = place.address_components[i].types[0];
          if (componentForm[addressType]) {
            var val = place.address_components[i][componentForm[addressType]];
            if (addressType !='route'){
              if (addressType == 'country'){
                $("#country").select2().val(val);
                $("#country").select2().val();

              }else if (addressType == 'street_number'){
                r = place.address_components[1][componentForm['route']]
                document.getElementById(addressType).value = val+' '+r
              }else{
                document.getElementById(addressType).value = val;
              }
            }
          }
        }
      }
    }

    if(mobile == 'true'){
      $('#schedule-from-datepicker').on('change', function() {
          $('#schedule-to-datepicker').prop('min', $(this).val());
          $('#schedule-to-datepicker').val($(this).val());
      });
    }

    if ($('#account_name').length > 0 ){
        address_auto_fill(document.getElementById("account_name"));
    }
    if ($('#street_number').length > 0){
        address_auto_fill(document.getElementById("street_number"));
    }
    // var path = window.location.pathname
    // if((path.includes('/accounts/') || path.includes('/users/')) && (path.includes('/edit') || path.includes('/new'))){
    //   if (document.getElementById("account_name") != null){
    //       address_auto_fill(document.getElementById("account_name"));
    //     }else{
    //       address_auto_fill(document.getElementById("street_number"));
    //   }
    // }

    $('body').bind('ajax:beforeSend', function(event, xhr, settings) {
      console.log("ajax-beforesend");
      $("#preloader").show();
    });

    $('body').bind('ajax:complete', function(xhr, status) {
      console.log("ajax-complete");
      $("#preloader").hide();
    });

    $('.datepicker').datepicker();

    if(mobile == 'false'){
      $('#schedule-from-datepicker, #meeting-reminder-date').datepicker({
        dateFormat: 'mm/dd/yy',
        altField: "#schedule-to-datepicker",
        altFormat: "mm/dd/yy",
        onSelect: function (selected) {
          var dt = new Date(selected);
          dt.setDate(dt.getDate());
          $("#schedule-to-datepicker").datepicker("option", "minDate", dt);
        }
      });
      $('#schedule-to-datepicker').datepicker({
        dateFormat: 'mm/dd/yy'
      });
    }


    var now = new Date();
    var mins = now.getMinutes();
    var quarterHours = Math.round(mins/15);
    if (quarterHours == 4)
    {
        now.setHours(now.getHours()+1);
    }
    rounded = (quarterHours*15)%60;
    now.setMinutes(rounded);
    var d = now
    var hh = d.getHours();
    var m = d.getMinutes();
    var dd = 'AM';
    var h = hh;
    if (h >= 12) {
        h = hh-12;
        dd = "PM";
    }
    if (h == 0) {
        h = 12;
    }
    m = m<10?"0"+m:m;
    var current_time = h+":"+m+" "+dd;

    $('#schedule-from-timepicker').timepicker({
      minuteStep: 15,
      defaultTime: current_time
    });

    $('#schedule-to-timepicker').timepicker({
      minuteStep: 15
    });
    $('#scheduleFromTimePicker').timepicker().on('hide.timepicker', function(e) {
      $('#schedule-to-timepicker').timepicker('setTime', e.time.value);
    });

    $(".account_next").click(function(){
       address_auto_fill(document.getElementById("street_number"));
    });


    $(document).on('click', '.jumpin', function(){
      var conversation_id = $(this).data('conversation-id')
      var cid = $(this).attr('id')
      $('#'+cid).hide();
      $('#preloader').show();
      $.ajax({
        type: "POST",
        url : '/accounts/jump_in?conversation_id='+conversation_id+'&cid='+cid,
        beforeSend: function(xhr) {
          xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
        },
        complete: function() {
          $('#preloader').hide();
          $('#'+cid).switchClass("jumpin", "checkin");
          $('#'+cid).parent().find('.position_button').text('Check In');
          $('#'+cid).show();
        },
        success: function() {
        },
        error:function() {
        }
      });
    });

    $(document).on('click', '.checkin', function(){
      checkin(this);
    });

    $(document).on('click', '.checkout', function(){
      checkout(this);
    });

    function checkin(parent) {
      var self = parent;
      var created_by = $(parent).data('created-by')
      var conversation_id = $(parent).data('conversation-id')
      //immediately show loader
      $('#'+self.id).hide();
      $('#preloader').show();
      navigator.geolocation.getCurrentPosition(
        function(position) {
          savePosition(position, "checkin", "success", self.id, created_by, conversation_id);
        },
        function(position) {
          savePosition(position, "checkin", "error", self.id, created_by, conversation_id);
        }
      );
    }

    function checkout(parent) {
      var self = parent;
      var created_by = $(parent).data('created-by')
      var conversation_id = $(parent).data('conversation-id')
      //immediately show loader
      $('#'+self.id).hide();
      $('#preloader').show();
      navigator.geolocation.getCurrentPosition(
        function(position) {
          savePosition(position, "checkout", "success", self.id, created_by, conversation_id);
        },
        function(position) {
          savePosition(position, "checkout", "error", self.id, created_by, conversation_id);
        }
      );
    }

    function savePosition(position, type, result, cid, created_by, conversation_id) {
      var url = null;
      var lat = null;
      var lng = null;

      if (result == "success") {
        lat = position.coords.latitude;
        lng = position.coords.longitude;
      }

      if(type == "checkin") {
        url = '/accounts/check_in';
      }

      if(type == "checkout") {
        url = '/accounts/check_out';
      }

      <%unless superadmin_logged_in?%>
        $.getJSON("https://api.ipify.org?format=json", function(data){
          var ip_address = data.ip;
          $.ajax({
            url : url,
            method: 'POST',
            data: { cid: cid, lat: lat, lng: lng, ip_address: ip_address, created_by: created_by, conversation_id: conversation_id },
            beforeSend: function(xhr) {
              xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
            },
            complete: function() {
              $('#preloader').hide();
              var current_user = "<%=current_user.id rescue nil%>";
              if(type == "checkin"){
                $('#'+cid).switchClass("checkin", "checkout");
                $('#'+cid).parent().find('.position_button').text('Check Out');
                $('#'+cid).parent().find('.fa-sign-in').switchClass("fa-sign-in", "fa-sign-out");
                $('#'+cid).show();
                $('.check_in_time_'+cid).removeClass('hidden')
                if(current_user == created_by){
                  $('.citem_'+cid).text("in_progress");
                  $('.citem_'+cid).css("color", "#FF0000");
                  $('.citem_'+cid).css("border", "1px solid #FF0000");
                }
              }else if(type == "checkout"){
                $('.check_out_time_'+cid).removeClass('hidden')
                if(current_user == created_by){
                  $('.citem_'+cid).text("completed");
                  $('.citem_'+cid).css("color", "#4CAF50");
                  $('.citem_'+cid).css("border", "1px solid #4CAF50");
                }
              }
            },
            success: function() {
            },
            error:function() {
            }
          });
        });
      <%end%>
    }

    $(".amount_val").keypress(function(event) {
      if ((event.which != 46 || $(this).val().indexOf('.') != -1) &&
        ((event.which < 48 || event.which > 57) &&
          (event.which != 0 && event.which != 8))) {
        event.preventDefault();
      }
      var text = $(this).val();
      if ((text.indexOf('.') != -1) &&
        (text.substring(text.indexOf('.')).length > 2) &&
        (event.which != 0 && event.which != 8) &&
        ($(this)[0].selectionStart >= text.length - 2)) {
        event.preventDefault();
      }
    });

    $(".amount_val").focusout(function(){
       var re = /^-?[0-9]+$/;
       var num = $(this).val();
       if (re.test(num)){
          num = num + '.00';
          $(this).val(num);
       }else if(!re.test(num) && num != '' ){
         var length = parseFloat(num).toFixed(2).replace(/^-?\d*\.?|0+$/g, '').length
         if(length == 1){
          num = num + '0';
          $(this).val(num);
        }else if (length < 1){
          num = parseFloat(num) + '.00';
          $(this).val(num);
        }
      }
    });

    $(document).on('click', '.delete_item', function(){
      $(".delete-meeting-modal-form").modal('show');
      var item_id = $(this).data('id')
      var account_id = $(this).data('account-id')
      $(".delete-meeting-modal-form").data('id', item_id)
      $(".delete-meeting-modal-form").data('account_id', account_id)
    })

    $(document).on('click', '#ok_delete_meeting', function(){
      var item_id =   $(".delete-meeting-modal-form").data('id')
      var account_id = $(".delete-meeting-modal-form").data('account_id')
      $(".delete-meeting-modal-form").modal('hide');
      $('#preloader').css('opacity', 0.8);
      $('#preloader').show();
      $.ajax({
        type: "GET",
        url: '/accounts/'+account_id+'/delete_meeting?item_id='+ item_id,
        success: function (data) {
        }
      });
    });

    $(document).on('click', '#yes_delete_future_meeting, #no_delete_future_meeting, #modal_cross_button', function(){
      var item_id =  $(".delete-future-meeting-modal-form").data('id')
      var account_id = $(".delete-future-meeting-modal-form").data('account_id')
      var button_id = $(this).attr('id')
      if(button_id == 'yes_delete_future_meeting'){
       var url = '/accounts/'+account_id+'/delete_future_meeting?citem_id='+item_id+'&destroy_future_meetings=' + true
      }else{
       var url = '/accounts/'+account_id+'/delete_future_meeting?citem_id='+item_id
      }
      $(".delete-future-meeting-modal-form").modal('hide');
      $('#preloader').css('opacity', 0.8);
      $('#preloader').show();
      $.ajax({
        type: "DELETE",
        url: url,
        success: function (data) {
        }
      });
    });
  });
</script>
<!-- end of shared javascript -->
