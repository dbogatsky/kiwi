<% content_for :pageheader do %>
  <h2><i class="fa fa-map-marker"></i>Tracking Report</h2>
<% end %>

<div class="gps-tracking">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <div class="pull-right arrow-mrg">
           <i class="fa fa-arrow-up full-screen-action up-arrow" aria-hidden="true" id="full-screen"></i>
           <i class="fa fa-arrow-down full-screen-action down-arrow" aria-hidden="true" style="display: none"></i>
        </div>
      </h4>
    </div>
    <div class="panel-body">
      <div class="row">
        <div class="col-sm-4">
          <%=select_tag "user-visits", options_for_select(@users.map{|u| ["#{u.first_name}" +" "+ "#{u.last_name}", u.id]}, params[:user]), {prompt: "-- Select Name --", class: 'form-control'} %>
        </div>
        <div class="col-sm-3">
          <div class="input-group ">
            <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
              <input type="text" class="form-control user-data-picker" placeholder="mm/dd/yy" name="date" id="schedule-from-datepicker" required="required" value="<%=DateTime.parse(params[:date]).strftime('%m/%d/%Y') if !params[:date].nil? && params[:date] != ''%>"/>
          </div>
        </div>
      </div>
      <div class="row navigation">
        <div class="col-sm-6">
        </div>
      </div>

      <div class="row">
        <div class="col-sm-10">
          <%= check_box_tag 'visit','visit-user' %>
          <%= label_tag 'visit', "Visits", class: ''%> &nbsp;&nbsp;&nbsp;

          <%= check_box_tag 'tracking' %>
          <%= label_tag 'tracking', "Tracking", class: ''%>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="col-sm-12 map-layout">
  <div id="map" style="height: 500px"></div>
</div>

<div class="col-sm-12">
  <div class="places-position">
    <span class="places-action">
      <i class="fa fa-map-marker" aria-hidden="true"></i>
      Schedule</span>
  </div>
</div>

<div class="col-sm-2 box-place">
  <div class="box" style="height: 150px">
    <p>Ahmedabad</p>
    <p>Surat</p>
    <p>Bhavnagar</p>
    <p>Rajkot</p>
    <p>Baroda</p>
  </div>
</div>

<% if @allPosition.present? %>
  <%= javascript_include_tag "Leaflet.js" %>
  <%= javascript_include_tag "Leaflet_AwesomeMarkers.js" %>
  <%= javascript_include_tag "LeafletPlayback.js" %>
  
  <script type="text/javascript">
    var mapsetView1 = <%=JSON.parse(@allPosition)['geometry']['coordinates'][0][0].to_f unless @allPosition.nil?%>
    var mapsetView0 = <%=JSON.parse(@allPosition)['geometry']['coordinates'][0][1].to_f unless @allPosition.nil?%>
    var demoTracks = [<%=@allPosition.html_safe unless @allPosition.nil?%>];
    var startDate = '<%= DateTime.parse(params[:date]).beginning_of_day.strftime("%m/%d/%Y")%>';
    var startTimeGps = "<%= Time.at(JSON.parse(@allPosition)['properties']['time'][0]).to_datetime.strftime('%I:%M:%S %p')%>".toString();
    $('#tracking').attr('checked', true);
    $('.places-position').addClass('places-navigation');
  </script>

  <%= javascript_include_tag "example_2_control.js" %>
  <%= javascript_include_tag "example_2.js" %>
 
  <script type="text/javascript">
    $(document).ready(function() {
      var markerImg = 'url(/marker_image/<%=params[:user]%>) no-repeat 0 0';
      $(".awesome-marker-shadow").css({'background':markerImg});
    });
  </script>

<% else %>

  <script type="text/javascript">
    $('.navigation').css({'height' : '0px'});
    $('.down-arrow').css({'display':'none'});
    $('.places-position').addClass('places');
    $(document).ready(function() {
      (function() {
        // map options
        var options = {
            zoom: 5,
            center: new google.maps.LatLng(39.909736, -98.522109), // centered US
            mapTypeId: google.maps.MapTypeId.TERRAIN,
            mapTypeControl: false
        };
        // init map
        var map = new google.maps.Map(document.getElementById('map'), options);
        })();
    });
  </script>
<% end %>

<script type="text/javascript">
	$('#tracking').on('change', function(){
		if ($('#tracking').attr('checked')){
			var user = $('select#user-visits option:selected').val();
			var date = $("#schedule-from-datepicker").datepicker( 'getDate' );
			if (user != null && user != '' && date != null && date != ''){
				window.location.href = "/gps_tracking_report?user="+user+"&date="+date;
			} else{
        alert('You Missed Something!');
      }
		}else{
			console.log('Please checked.');
		}
	});
</script>

<script type="text/javascript">
  $('.full-screen-action').on('click', function(){
    if($('#map').hasClass('full-screen') || ($('#map').hasClass('full-screen-with-navigation')) ){
      if($('.transport').length > 0)
      {
        $('#map').removeClass('full-screen-with-navigation');
      }else{
        $('#map').removeClass('full-screen');
      } 
      $('.down-arrow').css({'display':'none'});
      $('.up-arrow').css({'display':'block'});
    } else {
      if($('.transport').length > 0)
      {
        $('#map').addClass('full-screen-with-navigation');
      }else{
        $('#map').addClass('full-screen');
      }  
      $('.up-arrow').css({'display':'none'});
      $('.down-arrow').css({'display':'block'});
    }
  });
  $(document).keyup(function(e) { 
    if (e.which == 27){
      $('#map').removeClass('full-screen'); 
    } 
  });
</script>

<script type="text/javascript">
  $('.places-action').on('click', function(){
    if($('.box-place').hasClass('hide')){
      $('.box-place').removeClass('hide');
    }else{
      $('.box-place').addClass('hide');
    }
  });
</script>
