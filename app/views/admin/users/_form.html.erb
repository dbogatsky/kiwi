<%= content_for :head_assets do %>
  <script src="/assets/bootstrap/js/fullcalendar.min.js"></script>
  <script src="/assets/bootstrap/js/jquery.ui.touch-punch.min.js"></script>
<% end %>
<div class="panel panel-default">
	<div class="panel-heading">
		<p>Fill in the details below to add a user</p>
	</div>
	<div class="panel-body">
	  <%= simple_form_for @user, :url =>  (@user.new_record? ? admin_company_users_path : admin_company_user_path(company_id:  @company.id, id: @user.id)) , html: {class: "form-horizontal", multipart: true } do |f| %>

	    <div class="form-group">
	      <label class="col-sm-3 control-label">Email<span class="asterisk">*</span></label>
	      <div class="col-sm-6">
	        <%=email_field_tag 'user[email]', @user.try(:email), class: 'form-control', required: true, disabled: @user.new_record? ? false : true%>
	      </div>
	    </div>
	    <div class="form-group">
	      <label class="col-sm-3 control-label">First Name<span class="asterisk">*</span></label>
	      <div class="col-sm-6">
	        <%=text_field_tag 'user[first_name]', @user.try(:first_name), class: 'form-control', required: true%>
	      </div>
	    </div>
	    <div class="form-group">
	      <label class="col-sm-3 control-label">Last Name<span class="asterisk">*</span></label>
	      <div class="col-sm-6">
	        <%=text_field_tag 'user[last_name]', @user.try(:last_name), class: 'form-control', required: true%>
	      </div>
	    </div>
      <% if @user.new_record? %>
	      <div class="form-group">
	        <label class="col-sm-3 control-label">Password<span class="asterisk">*</span></label>
		      <div class="col-sm-6">
		        <%=password_field_tag 'user[password]', nil, class: 'form-control', required: true%>
		      </div>
	      </div>
	      <div class="form-group">
	        <label class="col-sm-3 control-label">Confirm Password<span class="asterisk">*</span></label>
		      <div class="col-sm-6">
		        <%=password_field_tag 'user[confirm_password]', nil, class: 'form-control', required: true%>
		      </div>
	      </div>
      <%end%>
	    <div class="form-group">
	      <label class="col-sm-3 control-label">Role<span class="asterisk">*</span></label>
	      <div class="col-sm-2">
	      <%rol = @user.new_record? ? '' : (@user.roles.present? ? @user.roles.last.id : '')%>
	       <%=select_tag "user[role_ids][]", options_for_select(BoRole.all.map{|c| [c.name, c.id] }, selected: "#{rol}"), {prompt: "-- select --", :class => 'form-control sel_role', required: true}%>
	      </div>
	      <div class="show_entity">
		      <label class="col-sm-1 control-label">Entity<span class="asterisk">*</span></label>
			      <div class="col-sm-2">
			         <%en = @user.new_record? ? '' : (@user.entity.present? ? @user.entity.id : '') %>
			         <%=select_tag "user[company_entity_id]", options_for_select(BoCompanyEntity.all.map{|c| [c.name, c.id] }, selected: "#{en}"), {prompt: "-- select --", :class => 'form-control sel_clear', required: true}%>
			      </div>
	      </div>
	    </div>
	    <div class="form-group">
	      <label class="col-sm-3 control-label">Locale<span class="asterisk">*</span></label>
	      <div class="col-sm-6">
	        <%=select_tag('user[locale]', options_for_select([['English', 'en']], selected: @user.try(:locale) ), {prompt: "-- select --", :class => 'form-control', required: true})%>
	      </div>
	    </div>
      <div class="form-group">
        <label class="col-sm-3 control-label">Time Zone<span class="asterisk">*</span></label>
	      <div class="col-sm-6">
	        <%=select_tag('user[time_zone]', options_for_select(ActiveSupport::TimeZone.all.sort.map{|z| ['(UTC '+"#{z.formatted_offset}"+')  ' +"#{z.name}", z.name]} ,selected: @user.try(:time_zone)), {prompt: "-- select --", :class => 'form-control', required: true})%>
	      </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label">Street Address<span class="asterisk">*</span></label>
	      <div class="col-sm-6">
	        <%= text_field_tag 'user[addresses_attributes][0][street_address]' , @address.try(:street_address), class: 'form-control', required: true, id: 'street_number'%>
	      </div>
      </div>

      <div class="form-group">
        <label class="col-sm-3 control-label">Suite Number</label>
	      <div class="col-sm-6">
	        <%= text_field_tag 'user[addresses_attributes][0][suite_number]' , @address.try(:suite_number), class: 'form-control', id: 'subpremise', readonly: true%>
	      </div>
      </div>

      <div class="form-group">
        <label class="col-sm-3 control-label">City<span class="asterisk">*</span></label>
	      <div class="col-sm-6">
	        <%= text_field_tag 'user[addresses_attributes][0][city]', @address.try(:city), class: 'form-control', required: true, id: 'locality', readonly: true%>
	      </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label">Province/State<span class="asterisk">*</span></label>
	      <div class="col-sm-6">
	        <%= text_field_tag 'user[addresses_attributes][0][region]', @address.try(:region), class: 'form-control', required: true, id: 'administrative_area_level_1', readonly: true%>
	      </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label">Post/Zipcode<span class="asterisk">*</span></label>
	      <div class="col-sm-6">
	        <%= text_field_tag 'user[addresses_attributes][0][postcode]' ,@address.try(:postcode), class: 'form-control', required: true, id: 'postal_code', readonly: true%>
	      </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label">Country<span class="asterisk">*</span></label>
	      <div class="col-sm-6">
	        <%=country_select("user[addresses_attributes][0]", 'country', {priority_countries: ["GB", "FR", "DE"], selected: @address.try(:country) }, {class: 'form-control', prompt: "Select Country", required: true, id: 'country', readonly: true})%>
	      </div>
      </div>
      <%=hidden_field_tag 'user[addresses_attributes][0][id]',@address.try(:id)%>
      <%=hidden_field_tag 'user[addresses_attributes][0][latitude]', @address.try(:latitude), id: 'account_lat'%>
      <%=hidden_field_tag 'user[addresses_attributes][0][longitude]', @address.try(:longitude), id: 'account_lng' %>
      <div class="form-group">
        <label class="col-sm-3 control-label">Phone:</label>
        <div class="col-sm-2">
          <%contact_value = @contact.first.value rescue nil%>
          <%=hidden_field_tag "user[contacts_attributes][][type]",'phone'%>
          <%=text_field_tag "user[contacts_attributes][][value]",contact_value, {class: "form-control", required: true}%>
          <% contact_id = @contact.first.id rescue nil %>
          <%=hidden_field_tag "user[contacts_attributes][][id]",contact_id%>
        </div>
        <label class="col-sm-1 control-label">Mobile:</label>
        <div class="col-sm-2">
          <%contact_value1 = @contact.last.value rescue nil%>
          <%=hidden_field_tag "user[contacts_attributes][][type]",'mobile'%>
          <%=text_field_tag "user[contacts_attributes][][value]",contact_value1, {class: "form-control", required: true}%>
          <% contact_id1 = @contact.last.id rescue nil %>
          <%=hidden_field_tag "user[contacts_attributes][][id]",contact_id1%>
        </div>
      </div>
	    <div class="form-group">
	      <label class="col-sm-3 control-label">Picture</label>
	      <div class="col-sm-6">
	        <label title="Upload image file" for="inputImage" class="btn btn-white">
	          <%=file_field_tag "user[avatar]"%>
	        </label>
	      </div>
	    </div>
		</div><!-- panel-body -->

		<div class="panel-footer">
			<div class="row">
				<div class="col-sm-6 col-sm-offset-3">
				 <%=submit_tag 'Save', class: 'btn btn-primary'%>
					&nbsp;
					<button class="btn btn-default" name="cancel" id="cancel">Cancel</button>
				</div>
			</div>
		</div><!-- panel-footer -->
	<% end %>
</div>

<script>
	$(function(){
		// validate form
		$(".simple_form").validate({
		  highlight: function(element) {
		    jQuery(element).closest('.form-group').removeClass('has-success').addClass('has-error');
		  },
		  success: function(element) {
		    jQuery(element).closest('.form-group').removeClass('has-error');
		  }
		});
	});

	// default case
	if ( $('.sel_role').val() == 1 || $('.sel_role').val() == '' ) {
	  $(".show_entity").hide();
	  $(".sel_clear").val('');
	}

	// when an entity is selected
	$('.sel_role').change(function(){
	  if($(this).val() == 1 || $(this).val() == '' )
	    {
	      $(".show_entity").hide();
	    	$(".sel_clear").val('');
	    }else
	    {
	     $(".show_entity").show();
	    }
	});

	<% if @user.new_record?%>
		$(function(){
			$( "#new_user" ).validate({
				debug: true,
			  rules: {
			   'user[password]': {
			   		required: true,
			   		minlength: 8
			    },
			    'user[confirm_password]': {
			      equalTo: "#user_password",
			      minlength: 8
			    }
			  },
			  submitHandler: function (form) {
			  	form.submit();
	      }
			});
		});
	<%end%>
</script>